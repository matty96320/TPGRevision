<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OECD Transfer Pricing Guidelines 2022 Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-option:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .streak-fire { color: #f97316; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6; width: 24px; height: 24px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col text-slate-800">

    <header class="bg-blue-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-xl font-bold leading-tight">OECD TP Quiz <span class="text-blue-300 text-sm font-normal block sm:inline">2022 Guidelines</span></h1>
                </div>
                <button id="settings-btn" class="text-blue-300 hover:text-white transition-colors p-2 rounded-full hover:bg-blue-800" title="Settings">
                    <i class="fas fa-cog fa-lg"></i>
                </button>
            </div>
            <div class="flex items-center space-x-6">
                <div class="text-center">
                    <p class="text-xs text-blue-300 uppercase tracking-wider">Score</p>
                    <p class="font-bold text-xl" id="score-display">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-blue-300 uppercase tracking-wider">Streak</p>
                    <div class="flex items-center justify-center space-x-1">
                        <i class="fas fa-fire" id="streak-icon"></i>
                        <p class="font-bold text-xl" id="streak-display">0</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="bg-white border-b border-slate-200 shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-2 flex flex-wrap justify-between items-center text-sm">
            <div class="flex items-center space-x-2 mb-2 sm:mb-0">
                <span class="text-slate-500">Difficulty:</span>
                <span id="difficulty-badge" class="px-2 py-1 rounded bg-green-100 text-green-800 font-semibold text-xs border border-green-200">Beginner</span>
                <span id="auto-mode-indicator" class="text-xs text-slate-400 italic">(Auto-adjusting)</span>
            </div>
            <div class="flex items-center space-x-4">
                <label class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="manual-mode-toggle" class="sr-only">
                        <div class="block bg-slate-300 w-10 h-6 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                    </div>
                    <div class="ml-3 text-slate-600">Manual Mode</div>
                </label>
                <select id="manual-difficulty-select" class="hidden form-select block w-full pl-3 pr-10 py-1 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md border">
                    <option value="1">Beginner</option>
                    <option value="2">Intermediate</option>
                    <option value="3">Advanced</option>
                </select>
            </div>
        </div>
    </div>

    <main class="flex-grow flex flex-col items-center justify-start pt-8 px-4 pb-12 relative">
        <div class="w-full max-w-3xl">
            
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>

            <div id="ai-indicator" class="hidden mb-2 text-right text-xs font-semibold text-purple-600 flex items-center justify-end gap-1">
                <i class="fas fa-robot"></i> AI Generated
            </div>

            <div id="quiz-container" class="bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200 fade-in relative min-h-[400px]">
                
                <div id="loading-overlay" class="absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center hidden">
                    <div class="loader mb-3"></div>
                    <p class="text-slate-500 text-sm animate-pulse">Consulting the Guidelines...</p>
                </div>

                <div class="bg-slate-50 px-6 py-3 border-b border-slate-100 flex justify-between items-center">
                    <span id="chapter-tag" class="text-xs font-bold tracking-wider text-slate-500 uppercase">Start Quiz</span>
                    <span id="question-count" class="text-xs text-slate-400">Question 1</span>
                </div>

                <div class="p-6 sm:p-8">
                    <h2 id="question-text" class="text-xl sm:text-2xl font-semibold text-slate-800 mb-6 leading-relaxed">
                        Initializing...
                    </h2>

                    <div id="options-container" class="space-y-3">
                        </div>
                </div>

                <div id="feedback-section" class="hidden bg-slate-50 border-t border-slate-200 p-6 sm:p-8">
                    <div class="flex items-start space-x-3 mb-4">
                        <div id="feedback-icon" class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-white"></div>
                        <div>
                            <h3 id="feedback-title" class="text-lg font-bold"></h3>
                            <p id="feedback-text" class="text-slate-600 mt-1 leading-relaxed"></p>
                        </div>
                    </div>
                    <button id="next-btn" class="w-full sm:w-auto px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow transition-colors float-right">
                        Next Question <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>

            </div>
        </div>
    </main>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center px-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-800">Settings</h3>
                <button id="close-settings" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 mb-2">Google Gemini API Key</label>
                <input type="password" id="api-key-input" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition" placeholder="Enter your API Key here...">
                <p id="api-input-help" class="text-xs text-slate-500 mt-2">
                    An API Key is required. 
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-600 hover:underline">Get a free key here.</a>
                </p>
            </div>

            <div class="flex justify-end">
                <button id="save-settings" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Save & Close</button>
            </div>
        </div>
    </div>

    <footer class="bg-white border-t border-slate-200 py-6 mt-auto">
        <div class="max-w-4xl mx-auto px-4 text-center text-slate-500 text-sm">
            <p>Based on the <a href="https://www.oecd.org/tax/transfer-pricing/oecd-transfer-pricing-guidelines-for-multinational-enterprises-and-tax-administrations-20769717.htm" target="_blank" class="text-blue-600 hover:underline">OECD Transfer Pricing Guidelines 2022</a>.</p>
            <p class="mt-1">Powered by Google Gemini.</p>
        </div>
    </footer>

    <script>
        // --- USER CONFIGURATION ---
        // ðŸš¨ IMPORTANT: You can replace "YOUR_API_KEY_HERE" below, OR use the Settings button in the app
        const HARDCODED_API_KEY = "YOUR_API_KEY_HERE"; 
        const PLACEHOLDER_KEY = "YOUR_API_KEY_HERE"; 

        // --- Configuration & State ---
        const state = {
            score: 0,
            streak: 0,
            difficulty: 1, // 1: Beginner, 2: Intermediate, 3: Advanced
            isManualMode: false,
            questionCount: 0,
            consecutiveCorrect: 0,
            consecutiveWrong: 0,
            // Priority: 1. Hardcoded (if changed) 2. Local Storage
            apiKey: (HARDCODED_API_KEY && HARDCODED_API_KEY !== PLACEHOLDER_KEY) 
                    ? HARDCODED_API_KEY 
                    : (localStorage.getItem('oecd_quiz_api_key') || ''),
            isUsingAI: false,
            lastTopic: "" 
        };

        // --- Question Topic Randomizer ---
        const topicsByDifficulty = {
            1: [ // Beginner
                "Definition of Associated Enterprises",
                "The definition of the Arm's Length Principle (Article 9)",
                "The 5 Comparability Factors",
                "Functional Analysis (Functions, Assets, Risks)",
                "Purpose of Transfer Pricing Documentation",
                "Master File vs Local File basics",
                "Safe Harbours (General Concept)"
            ],
            2: [ // Intermediate
                "Selection of the Most Appropriate Method",
                "CUP Method (Comparable Uncontrolled Price) specific requirements",
                "Resale Price Method mechanics",
                "Cost Plus Method mechanics",
                "TNMM (Transactional Net Margin Method) application",
                "Transactional Profit Split Method: Contribution vs Residual analysis",
                "Intangibles: Legal ownership vs Economic substance",
                "Intra-group services: Benefit test"
            ],
            3: [ // Advanced
                "Hard-to-value intangibles (HTVI) approach",
                "DEMPE functions (Development, Enhancement, Maintenance, Protection, Exploitation)",
                "Financial Transactions (Treasury functions, Guarantees, Cash pooling)",
                "Business Restructurings (Chapter IX)",
                "Cost Contribution Arrangements (CCAs)",
                "Attribution of Profits to Permanent Establishments",
                "Advance Pricing Arrangements (APAs) & MAP"
            ]
        };

        // --- UI Elements ---
        const ui = {
            score: document.getElementById('score-display'),
            streak: document.getElementById('streak-display'),
            streakIcon: document.getElementById('streak-icon'),
            progressBar: document.getElementById('progress-bar'),
            difficultyBadge: document.getElementById('difficulty-badge'),
            autoIndicator: document.getElementById('auto-mode-indicator'),
            manualToggle: document.getElementById('manual-mode-toggle'),
            manualSelect: document.getElementById('manual-difficulty-select'),
            questionText: document.getElementById('question-text'),
            chapterTag: document.getElementById('chapter-tag'),
            questionCount: document.getElementById('question-count'),
            optionsContainer: document.getElementById('options-container'),
            feedbackSection: document.getElementById('feedback-section'),
            feedbackIcon: document.getElementById('feedback-icon'),
            feedbackTitle: document.getElementById('feedback-title'),
            feedbackText: document.getElementById('feedback-text'),
            nextBtn: document.getElementById('next-btn'),
            
            // AI & Settings
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsBtn: document.getElementById('close-settings'),
            saveSettingsBtn: document.getElementById('save-settings'),
            apiKeyInput: document.getElementById('api-key-input'),
            apiHelp: document.getElementById('api-input-help'),
            loadingOverlay: document.getElementById('loading-overlay'),
            aiIndicator: document.getElementById('ai-indicator')
        };

        let currentQuestion = null;

        // --- Logic ---

        function init() {
            // FIX: Always setup listeners first, so the Settings button works even if no key exists
            setupEventListeners();
            updateDifficultyUI();

            // Check if key exists
            if (state.apiKey) {
                ui.apiKeyInput.value = state.apiKey;
                
                // If the key comes from the hardcode, lock the input to indicate it's set in code
                if (HARDCODED_API_KEY !== PLACEHOLDER_KEY && state.apiKey === HARDCODED_API_KEY) {
                    ui.apiKeyInput.disabled = true; 
                    ui.apiHelp.innerHTML = "<span class='text-green-600 font-bold'><i class='fas fa-check-circle'></i> API Key loaded from code.</span>";
                }

                // Start!
                loadQuestion();
            } else {
                // If no key found, prompt user
                ui.questionText.innerText = "Welcome";
                ui.optionsContainer.innerHTML = `
                    <div class="bg-blue-50 p-6 rounded-lg text-center border border-blue-100">
                        <i class="fas fa-key text-blue-400 text-3xl mb-3"></i>
                        <p class="text-slate-600 mb-4">Please enter your Gemini API Key in settings to begin.</p>
                        <button id="start-setup-btn" class="px-6 py-2 bg-blue-600 text-white font-medium rounded-full hover:bg-blue-700 transition shadow-md">
                            Open Settings
                        </button>
                    </div>`;
                
                // Add listener to this specific temporary button
                setTimeout(() => {
                    const btn = document.getElementById('start-setup-btn');
                    if(btn) btn.onclick = () => ui.settingsModal.classList.remove('hidden');
                }, 100);
            }
        }

        function setupEventListeners() {
             ui.manualToggle.addEventListener('change', (e) => {
                state.isManualMode = e.target.checked;
                toggleManualModeUI();
                if (state.isManualMode) {
                    state.difficulty = parseInt(ui.manualSelect.value);
                }
                updateDifficultyUI();
            });

            ui.manualSelect.addEventListener('change', (e) => {
                if (state.isManualMode) {
                    state.difficulty = parseInt(e.target.value);
                    updateDifficultyUI();
                }
            });

            ui.nextBtn.addEventListener('click', loadQuestion);

            // Settings Modal
            ui.settingsBtn.addEventListener('click', () => ui.settingsModal.classList.remove('hidden'));
            ui.closeSettingsBtn.addEventListener('click', () => ui.settingsModal.classList.add('hidden'));
            ui.saveSettingsBtn.addEventListener('click', saveSettings);

            ui.settingsModal.addEventListener('click', (e) => {
                if (e.target === ui.settingsModal) ui.settingsModal.classList.add('hidden');
            });
        }

        function saveSettings() {
            const key = ui.apiKeyInput.value.trim();
            if(!key) {
                alert("Please paste your API Key.");
                return;
            }
            state.apiKey = key;
            localStorage.setItem('oecd_quiz_api_key', key);
            ui.settingsModal.classList.add('hidden');
            showToast("Settings Saved", "success");
            
            // Reload the question now that we have a key
            loadQuestion();
        }

        function toggleManualModeUI() {
            if (state.isManualMode) {
                ui.manualSelect.classList.remove('hidden');
                ui.autoIndicator.classList.add('hidden');
            } else {
                ui.manualSelect.classList.add('hidden');
                ui.autoIndicator.classList.remove('hidden');
            }
        }

        function updateDifficultyUI() {
            const labels = {1: "Beginner", 2: "Intermediate", 3: "Advanced"};
            const colors = {1: "bg-green-100 text-green-800 border-green-200", 2: "bg-yellow-100 text-yellow-800 border-yellow-200", 3: "bg-red-100 text-red-800 border-red-200"};
            
            ui.difficultyBadge.className = `px-2 py-1 rounded font-semibold text-xs border ${colors[state.difficulty]}`;
            ui.difficultyBadge.innerText = labels[state.difficulty];
        }

        // --- Question Generation (AI Only) ---

        async function loadQuestion() {
            // UI Reset
            ui.feedbackSection.classList.add('hidden');
            ui.optionsContainer.innerHTML = '';
            ui.optionsContainer.classList.remove('pointer-events-none');
            ui.loadingOverlay.classList.remove('hidden');
            
            // Double check API Key
            if (!state.apiKey || state.apiKey === PLACEHOLDER_KEY) {
                ui.loadingOverlay.classList.add('hidden');
                return; // Stop if still no key
            }

            try {
                currentQuestion = await fetchQuestionFromAI();
                state.isUsingAI = true;
                ui.aiIndicator.classList.remove('hidden');
            } catch (error) {
                console.error("AI Error:", error);
                ui.loadingOverlay.classList.add('hidden');
                ui.questionText.innerText = "Connection Error";
                ui.optionsContainer.innerHTML = `<div class="text-red-600 bg-red-50 p-4 rounded border border-red-200">
                    <strong>Could not get question:</strong> ${error.message}<br><br>
                    Please check your API Key in Settings.
                </div>`;
                return;
            }

            renderQuestion();
            ui.loadingOverlay.classList.add('hidden');
            
            state.questionCount++;
            ui.questionCount.innerText = `Question ${state.questionCount}`;
            const progress = (state.questionCount % 20) * 5; 
            ui.progressBar.style.width = `${progress}%`;
        }

        async function fetchQuestionFromAI() {
            const difficultyText = state.difficulty === 1 ? "Beginner" : 
                                   state.difficulty === 2 ? "Intermediate" : 
                                   "Advanced";
            
            // --- RANDOM TOPIC SELECTION LOGIC ---
            const availableTopics = topicsByDifficulty[state.difficulty];
            let randomTopic = availableTopics[Math.floor(Math.random() * availableTopics.length)];
            
            if (randomTopic === state.lastTopic) {
                randomTopic = availableTopics[Math.floor(Math.random() * availableTopics.length)];
            }
            state.lastTopic = randomTopic;

            const prompt = `
                You are an expert on the OECD Transfer Pricing Guidelines 2022.
                Generate a multiple-choice question.
                
                DIFFICULTY: ${difficultyText}
                TOPIC FOCUS: ${randomTopic}
                
                Requirements:
                1. Create a question strictly related to the "Topic Focus" above.
                2. Do NOT ask generic definitions if possible, try to create a small scenario or specific rule application.
                3. Provide 4 options.
                4. Return ONLY valid JSON.
                
                JSON Format:
                {
                    "chapter": "Chapter [Roman Numeral, e.g., Chapter I]",
                    "question": "Question text...",
                    "options": ["A", "B", "C", "D"],
                    "correct": 0,
                    "explanation": "Brief explanation referencing the guidelines."
                }
            `;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error.message || `HTTP Error ${response.status}`);
            }

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) throw new Error("No content generated by AI.");

            // FIX: Robust JSON Extraction
            let jsonString = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const firstBrace = jsonString.indexOf('{');
            const lastBrace = jsonString.lastIndexOf('}');
            
            if (firstBrace !== -1 && lastBrace !== -1) {
                jsonString = jsonString.substring(firstBrace, lastBrace + 1);
            }

            try {
                const q = JSON.parse(jsonString);
                return q;
            } catch (e) {
                throw new Error("Failed to parse AI response.");
            }
        }

        function renderQuestion() {
            ui.chapterTag.innerText = currentQuestion.chapter || "OECD Guidelines";
            ui.questionText.innerText = currentQuestion.question;
            
            currentQuestion.options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = "btn-option w-full text-left p-4 rounded-lg border border-slate-200 hover:border-blue-400 hover:bg-blue-50 transition-all duration-200 relative group bg-white";
                
                btn.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 font-bold text-sm mr-3 group-hover:bg-blue-200 group-hover:text-blue-700 transition-colors">
                            ${String.fromCharCode(65 + index)}
                        </span>
                        <span class="flex-grow">${opt}</span>
                    </div>
                `;
                
                btn.onclick = () => handleAnswer(index, btn);
                ui.optionsContainer.appendChild(btn);
            });
        }

        function handleAnswer(selectedIndex, btnElement) {
            ui.optionsContainer.classList.add('pointer-events-none');
            
            const isCorrect = selectedIndex === currentQuestion.correct;
            const correctBtn = ui.optionsContainer.children[currentQuestion.correct];

            // Update State
            if (isCorrect) {
                state.score += 10 + (state.streak * 2);
                state.streak++;
                state.consecutiveCorrect++;
                state.consecutiveWrong = 0;
                
                // Visuals
                btnElement.classList.remove('bg-white', 'border-slate-200');
                btnElement.classList.add('bg-green-100', 'border-green-500', 'text-green-900');
                
                showFeedback(true, "Correct!", currentQuestion.explanation);
            } else {
                state.streak = 0;
                state.consecutiveCorrect = 0;
                state.consecutiveWrong++;

                // Visuals
                btnElement.classList.remove('bg-white', 'border-slate-200');
                btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-900');
                
                // Highlight correct one
                if (correctBtn) {
                    correctBtn.classList.remove('bg-white', 'border-slate-200');
                    correctBtn.classList.add('bg-green-100', 'border-green-500', 'text-green-900');
                }

                showFeedback(false, "Incorrect", currentQuestion.explanation);
            }

            // Adjust Difficulty (Auto Mode)
            if (!state.isManualMode) {
                if (state.consecutiveCorrect >= 3 && state.difficulty < 3) {
                    state.difficulty++;
                    state.consecutiveCorrect = 0;
                    showToast("Level Up! Difficulty Increased.", "success");
                } else if (state.consecutiveWrong >= 2 && state.difficulty > 1) {
                    state.difficulty--;
                    state.consecutiveWrong = 0;
                    showToast("Difficulty Decreased.", "info");
                }
            }

            // Update Header Stats
            ui.score.innerText = state.score;
            ui.streak.innerText = state.streak;
            
            if (state.streak > 2) {
                ui.streakIcon.classList.add('streak-fire');
            } else {
                ui.streakIcon.classList.remove('streak-fire');
            }
            
            updateDifficultyUI();
        }

        function showFeedback(isCorrect, title, text) {
            ui.feedbackSection.classList.remove('hidden');
            ui.feedbackTitle.innerText = title;
            ui.feedbackText.innerText = text;
            
            if (isCorrect) {
                ui.feedbackIcon.className = "flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-white bg-green-500";
                ui.feedbackIcon.innerHTML = '<i class="fas fa-check"></i>';
                ui.feedbackTitle.className = "text-lg font-bold text-green-700";
            } else {
                ui.feedbackIcon.className = "flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-white bg-red-500";
                ui.feedbackIcon.innerHTML = '<i class="fas fa-times"></i>';
                ui.feedbackTitle.className = "text-lg font-bold text-red-700";
            }
            
            ui.feedbackSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showToast(message, type = "info") {
            const toast = document.createElement('div');
            const colors = type === "success" ? "bg-green-600" : type === "warning" ? "bg-orange-500" : "bg-blue-600";
            toast.className = `fixed bottom-4 right-4 ${colors} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-y-10 opacity-0 z-50 font-medium`;
            toast.innerText = message;
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            setTimeout(() => {
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Init
        init();

    </script>
</body>
</html>
